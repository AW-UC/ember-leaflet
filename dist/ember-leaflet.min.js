// ==========================================================================
// Project:   Ember Leaflet
// Copyright: Â©2013 Gabe Smedresman and contributors.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================



// Last commit: 9ce0ee7 (2013-06-12 12:15:55 -0700)


(function(){EmberLeaflet=Ember.Namespace.create(),L.DomUtil.TRANSITION&&L.Map.addInitHook(function(){L.DomEvent.on(this._mapPane,L.DomUtil.TRANSITION_END,function(){var e=this._zoomActions.shift();void 0!==e&&this.setZoom(e)},this)}),L.Map.include(L.DomUtil.TRANSITION?{_zoomActions:[],queueZoom:function(e){this._animatingZoom?this._zoomActions.push(e):this.setZoom(e)}}:{})})(),function(){var e=Ember.String.fmt;EmberLeaflet.LayerMixin=Ember.Mixin.create({_layer:null,_parentLayer:null,_childLayers:[],layer:Ember.computed(function(){return this._layer}).property(),parentLayer:Ember.computed(function(){return this._parentLayer}).property(),_newLayer:Ember.required(Function),parentLayerWillChange:Ember.beforeObserver(function(){this.get("parentLayer")&&this._destroyLayer()},"parentLayer"),parentLayerDidChange:Ember.observer(function(){this.get("parentLayer")&&this._createLayer()},"parentLayer"),_createLayer:function(){Ember.assert("Parent layer must be in leaflet.",!!this.get("parentLayer")._layer),this.propertyWillChange("layer"),this._layer=this._newLayer(),this.propertyDidChange("layer"),Ember.assert("Layer must have Leaflet methods.","function"==typeof this._layer.onAdd),this.get("parentLayer")._layer.addLayer(this._layer),this._createChildLayers()},_destroyLayer:function(){this._destroyChildLayers(),this.propertyWillChange("layer"),this.get("parentLayer")._layer.removeLayer(this._layer),this._layer=null,this.propertyDidChange("layer")},_createChildLayers:function(){Ember.assert("%@ layer must support adding objects.".fmt(this.toString()),"function"==typeof this._layer.addLayer||!this._childLayers.length);var e=this.get("childLayers")||[],t=this;this._childLayers=e.map(function(e){return t._createChildLayer(e)})},_createChildLayer:function(t,r){r=Ember.$.extend({controller:this.get("controller"),_parentLayer:this},r||{});var i,n=Ember.typeOf(t);return Ember.assert(e("layerClass %@ must be an Ember instance or class.",t?t.toString():"<undefined>"),"instance"===n||"class"===n),"instance"===n?(i=t,i.setProperties(r)):"class"===n&&(i=t.create(r)),i.propertyDidChange("parentLayer"),i},_destroyChildLayers:function(){this._childLayers.forEach(function(e){e._destroyLayer(),e.destroy()}),this._childLayers=[]}}),EmberLeaflet.Layer=Ember.Object.extend(EmberLeaflet.LayerMixin,{})}(),function(){EmberLeaflet.MapView=Ember.View.extend(EmberLeaflet.LayerMixin,{options:{attributionControl:!1},isMoving:!1,didInsertElement:function(){this._super(),this._createLayer()},willDestroyElement:function(){this._destroyLayer()},_createLayer:function(){this._layer||(this._layer=L.map(this.get("elementId"),this.get("options")),this._setEventHandlers(),this._createChildLayers(),this.setInitialViewArea())},_destroyLayer:function(){this._layer&&(this._destroyChildLayers(),this._unsetEventHandlers(),this._layer.remove(),this._layer=null)},_setEventHandlers:function(){this._layer.on("zoomend",this._onZoomEnd,this),this._layer.on("movestart",this._onMoveStart,this),this._layer.on("moveend",this._onMoveEnd,this),this._layer.on("move",this._onMove,this)},_unsetEventHandlers:function(){this._layer.off("zoomend",this._onZoomEnd,this),this._layer.off("movestart",this._onMoveStart,this),this._layer.off("moveend",this._onMoveEnd,this),this._layer.off("move",this._onMove,this)},_onZoomEnd:function(e){this.set("zoom",e.target.getZoom())},_onMoveStart:function(){this.set("isMoving",!0)},_onMoveEnd:function(){this.set("isMoving",!1)},_onMove:function(e){var t=e.target.getCenter();this.set("center",[t.lat,t.lng])},setInitialViewArea:function(){this.get("center")&&this.get("zoom")&&this._layer.setView(this.get("center"),this.get("zoom"))},zoomDidChange:Ember.observer(function(){this._layer&&this.get("zoom")&&this._layer.queueZoom(this.get("zoom"))},"zoom"),centerDidChange:Ember.observer(function(){this._layer&&this.get("center")&&(this.get("center"),this.get("isMoving")||this._layer.panTo(this.get("center")))},"center")})}(),function(){var e=Ember.get;EmberLeaflet.TileLayer=EmberLeaflet.Layer.extend({tileUrl:null,options:{},_newLayer:function(){return L.tileLayer(e(this,"tileUrl"),e(this,"options"))}})}(),function(){var e=Ember.get;EmberLeaflet.CollectionLayer=EmberLeaflet.Layer.extend({content:[],itemLayerClass:Ember.computed(function(){throw new Error("itemLayerClass must be defined.")}).property(),init:function(){this._super(),this._setupContent()},willDestroy:function(){this._teardownContent(),this._super()},contentWillChange:Ember.beforeObserver(function(){this._destroyChildLayers(),this._teardownContent()},"content"),contentDidChange:Ember.observer(function(){this._setupContent(),this._createChildLayers()},"content"),_setupContent:function(){e(this,"content")&&e(this,"content").addArrayObserver(this)},_teardownContent:function(){e(this,"content")&&e(this,"content").removeArrayObserver(this)},arrayWillChange:function(e,t,r){e.slice(t,t+r);var i=this._childLayers.slice(t,t+r);i.invoke("_destroyLayer"),i.invoke("destroy"),this._childLayers.splice(t,r)},arrayDidChange:function(e,t,r,i){var n=e.slice(t,t+i),a=this,s=n.map(function(e){return a._layerForObject(e)}),o=[t,0].concat(s);this._childLayers.splice.apply(this._childLayers,o)},_createLayer:function(){this._layer=e(this,"parentLayer")._layer,this._createChildLayers()},_destroyLayer:function(){this._destroyChildLayers(),this._layer=null},_createChildLayers:function(){if(e(this,"parentLayer")._layer){var t=this;this._childLayers=e(this,"content").map(function(e){return t._layerForObject(e)})}},_layerForObject:function(t){return this._createChildLayer(e(this,"itemLayerClass"),{content:t})}})}(),function(){var e=Ember.get,t=Ember.set,r=Ember.setProperties;EmberLeaflet.DraggableMixin=Ember.Mixin.create({isDragging:!0,isDraggable:!0,dragstart:function(){t(this,"isDragging",!0)},dragend:function(){r(this,{location:this._layer.getLatLng(),isDragging:!1})},isDraggableDidChange:Ember.observer(function(){this._layer&&this._layer._map&&(e(this,"isDraggable")?this._layer.dragging.enable():this._layer.dragging.disable())},"isDraggable"),layerWillChange:Ember.beforeObserver(function(){this._layer&&(this._layer.off("dragstart",this.dragstart,this),this._layer.off("dragend",this.dragend,this))},"layer"),layerDidChange:Ember.observer(function(){this._layer&&(this._layer.on("dragstart",this.dragstart,this),this._layer.on("dragend",this.dragend,this),this.propertyDidChange("isDraggable"))},"layer")})}(),function(){var e=Ember.get;EmberLeaflet.MarkerLayer=EmberLeaflet.Layer.extend({content:null,options:null,location:Ember.computed.alias("content.location"),locationDidChange:Ember.observer(function(){if(e(this,"location")&&!this._layer)this._createLayer();else if(this._layer&&!e(this,"location"))this._destroyLayer();else{var t=this._layer&&this._layer.getLatLng(),r=e(this,"location");t&&r&&!t.equals(r)&&this._layer.setLatLng(r)}},"location"),_newLayer:function(){return L.marker(e(this,"location"),e(this,"options"))},_createLayer:function(){!this._layer&&e(this,"location")&&(this._super(),this._layer.content=e(this,"content"))},_destroyLayer:function(){this._layer&&this._super()}})}(),function(){EmberLeaflet.MarkerCollectionLayer=EmberLeaflet.CollectionLayer.extend({itemLayerClass:EmberLeaflet.MarkerLayer,bounds:Ember.computed(function(){var e=this.get("content").filterProperty("location").mapProperty("location");return Ember.isEmpty(e)?null:new L.LatLngBounds(e)}).property("content.@each.location")})}(),"undefined"==typeof location||"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname||console.warn("You are running a production build of Ember on localhost and won't receive detailed error messages. If you want full error messages please use the non-minified build provided on the Ember website.");